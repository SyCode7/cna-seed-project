input {
    courier {
      port => 5000
      transport => "tcp"
  }
}

filter {
  if "haproxy" in [type] {
        grok {
                patterns_dir => "/logstash/patterns"
                match => ["message", "%{CUSTOMHAPROXY}"]
                add_tag => [ "request" ]
        }
        metrics {
                flush_interval => 5
                clear_interval => 5
                timer => ["time_duration", "%{time_duration}"]
                add_tag => ["metric", "shortterm"]
        }
        if !("metric" in [tags]) {
           metrics {
                flush_interval => 10
                clear_interval => 10
                timer => ["time_duration", "%{time_duration}"]
                add_tag => ["metric", "longterm"]
          }
        }
        if "request" in [tags] {
                metrics {
                        flush_interval => 5
                        clear_interval => 1
                        meter => ["events"]
                        add_tag => ["metric", "requests"]
                }
        }
  }
  if "webserver" in [type] {
        if "system_metrics" in [category] {
				if "disk" in [resource] and "I/O" in [disk-category] {
                        grok {
                                match => ["message", "%{NOTSPACE:epoch},%{BASE16FLOAT:read:float},%{BASE16FLOAT:write:float}"]
                        }
                } else {
                        grok {
                                match => ["message", "%{NOTSPACE:epoch},%{BASE16FLOAT:avg1m:float},%{BASE16FLOAT:avg10m:float},%{BASE16FLOAT:avg15m:float}"]
                                match => ["message", "%{NOTSPACE:epoch},%{BASE16FLOAT:value:float}"]
                                patterns_dir => ["/logstash-1.4.2.tar.gz/logstash-1.4.2/patterns", "/logstash/patterns"]
                        }
                }
				date {
					match => [ "epoch", "UNIX" ]
					target => "timestamp"
				}
        } else {
                grok {
					match => ["message", "%{COMBINEDAPACHELOG}"]
					match => ["message", "%{CUSTOMAPACHE}"]
					match => ["message", "%{ZURMO}"]
					patterns_dir => ["/logstash-1.4.2.tar.gz/logstash-1.4.2/patterns", "/logstash/patterns"]
                }
        } 
  }
  if "memcached" in [type] {
        grok {
                match => ["message", "%{MEMCACHED}"]
                patterns_dir => ["/logstash/patterns"]
                overwrite => [ "message" ]
        }
  }
}

output {
  elasticsearch {}
  if "cpu" in [resource] {
	etcd {
		etcd_ip => "10.1.42.1"
		etcd_port => 4001
		path => "/services/[type]/[service-id]/metrics/[resource]/[metric]"
		value_field => "value"
		ttl => 10
	}
  }
}
